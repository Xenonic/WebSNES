#include "CPU.h"
#include "Instructions.h"
#include "../../Cartridge.h"

#include <iostream>

void WDC65816::Tick()
{
	Execute(Disassemble(Fetch()));
}

uint8 WDC65816::Fetch()
{
	return Source->Read();
}

Instruction WDC65816::Disassemble(uint8 Data) const
{
	Instruction Result;

#define OPERATION(Op, HexValue) case HexValue: Result.OpCode = #Op; Result.Hex = HexValue; break;

	switch (Data)
	{
		OPERATION(ADC, 0x61)
		OPERATION(ADC, 0x63)
		OPERATION(ADC, 0x65)
		OPERATION(ADC, 0x67)
		OPERATION(ADC, 0x69)
		OPERATION(ADC, 0x6D)
		OPERATION(ADC, 0x6F)
		OPERATION(ADC, 0x71)
		OPERATION(ADC, 0x72)
		OPERATION(ADC, 0x73)
		OPERATION(ADC, 0x75)
		OPERATION(ADC, 0x77)
		OPERATION(ADC, 0x79)
		OPERATION(ADC, 0x7D)
		OPERATION(ADC, 0x7F)
		OPERATION(AND, 0x21)
		OPERATION(AND, 0x23)
		OPERATION(AND, 0x25)
		OPERATION(AND, 0x27)
		OPERATION(AND, 0x29)
		OPERATION(AND, 0x2D)
		OPERATION(AND, 0x2F)
		OPERATION(AND, 0x31)
		OPERATION(AND, 0x32)
		OPERATION(AND, 0x33)
		OPERATION(AND, 0x35)
		OPERATION(AND, 0x37)
		OPERATION(AND, 0x39)
		OPERATION(AND, 0x3D)
		OPERATION(AND, 0x3F)
		OPERATION(ASL, 0x06)
		OPERATION(ASL, 0x0A)
		OPERATION(ASL, 0x0E)
		OPERATION(ASL, 0x16)
		OPERATION(ASL, 0x1E)
		OPERATION(BCC, 0x90)
		OPERATION(BCS, 0xB0)
		OPERATION(BEQ, 0xF0)
		OPERATION(BIT, 0x24)
		OPERATION(BIT, 0x2C)
		OPERATION(BIT, 0x34)
		OPERATION(BIT, 0x3C)
		OPERATION(BIT, 0x89)
		OPERATION(BMI, 0x30)
		OPERATION(BNE, 0xD0)
		OPERATION(BPL, 0x10)
		OPERATION(BRA, 0x80)
		OPERATION(BRK, 0x00)
		OPERATION(BRL, 0x82)
		OPERATION(BVC, 0x50)
		OPERATION(BVS, 0x70)
		OPERATION(CLC, 0x18)
		OPERATION(CLD, 0xD8)
		OPERATION(CLI, 0x58)
		OPERATION(CLV, 0xB8)
		OPERATION(CMP, 0xC1)
		OPERATION(CMP, 0xC3)
		OPERATION(CMP, 0xC5)
		OPERATION(CMP, 0xC7)
		OPERATION(CMP, 0xC9)
		OPERATION(CMP, 0xCD)
		OPERATION(CMP, 0xCF)
		OPERATION(CMP, 0xD1)
		OPERATION(CMP, 0xD2)
		OPERATION(CMP, 0xD3)
		OPERATION(CMP, 0xD5)
		OPERATION(CMP, 0xD7)
		OPERATION(CMP, 0xD9)
		OPERATION(CMP, 0xDD)
		OPERATION(CMP, 0xDF)
		OPERATION(CPX, 0xE0)
		OPERATION(CPX, 0xE4)
		OPERATION(CPX, 0xEC)
		OPERATION(CPY, 0xC0)
		OPERATION(CPY, 0xC4)
		OPERATION(CPY, 0xCC)
		OPERATION(COP, 0x02)
		OPERATION(DEC, 0x3A)
		OPERATION(DEC, 0xC6)
		OPERATION(DEC, 0xCE)
		OPERATION(DEC, 0xD6)
		OPERATION(DEC, 0xDE)
		OPERATION(DEX, 0xCA)
		OPERATION(DEY, 0x88)
		OPERATION(EOR, 0x41)
		OPERATION(EOR, 0x43)
		OPERATION(EOR, 0x45)
		OPERATION(EOR, 0x47)
		OPERATION(EOR, 0x49)
		OPERATION(EOR, 0x4D)
		OPERATION(EOR, 0x4F)
		OPERATION(EOR, 0x51)
		OPERATION(EOR, 0x52)
		OPERATION(EOR, 0x53)
		OPERATION(EOR, 0x55)
		OPERATION(EOR, 0x57)
		OPERATION(EOR, 0x59)
		OPERATION(EOR, 0x5D)
		OPERATION(EOR, 0x5F)
		OPERATION(INC, 0x1A)
		OPERATION(INC, 0xE6)
		OPERATION(INC, 0xEE)
		OPERATION(INC, 0xF6)
		OPERATION(INC, 0xFE)
		OPERATION(INX, 0xE8)
		OPERATION(INY, 0xC8)
		OPERATION(JMP, 0x4C)
		OPERATION(JMP, 0x6C)
		OPERATION(JMP, 0x7C)
		OPERATION(JML, 0x5C)
		OPERATION(JML, 0xDC)
		OPERATION(JSR, 0x20)
		OPERATION(JSR, 0xFC)
		OPERATION(JSL, 0x22)
		OPERATION(LDA, 0xA1)
		OPERATION(LDA, 0xA3)
		OPERATION(LDA, 0xA5)
		OPERATION(LDA, 0xA7)
		OPERATION(LDA, 0xA9)
		OPERATION(LDA, 0xAD)
		OPERATION(LDA, 0xAF)
		OPERATION(LDA, 0xB1)
		OPERATION(LDA, 0xB2)
		OPERATION(LDA, 0xB3)
		OPERATION(LDA, 0xB5)
		OPERATION(LDA, 0xB7)
		OPERATION(LDA, 0xB9)
		OPERATION(LDA, 0xBD)
		OPERATION(LDA, 0xBF)
		OPERATION(LDX, 0xA2)
		OPERATION(LDX, 0xA6)
		OPERATION(LDX, 0xAE)
		OPERATION(LDX, 0xB6)
		OPERATION(LDX, 0xBE)
		OPERATION(LDY, 0xA0)
		OPERATION(LDY, 0xA4)
		OPERATION(LDY, 0xAC)
		OPERATION(LDY, 0xB4)
		OPERATION(LDY, 0xBC)
		OPERATION(LSR, 0x46)
		OPERATION(LSR, 0x4A)
		OPERATION(LSR, 0x4E)
		OPERATION(LSR, 0x56)
		OPERATION(LSR, 0x5E)
		OPERATION(MVN, 0x54)
		OPERATION(MVP, 0x44)
		OPERATION(NOP, 0xEA)
		OPERATION(ORA, 0x01)
		OPERATION(ORA, 0x03)
		OPERATION(ORA, 0x05)
		OPERATION(ORA, 0x07)
		OPERATION(ORA, 0x09)
		OPERATION(ORA, 0x0D)
		OPERATION(ORA, 0x0F)
		OPERATION(ORA, 0x11)
		OPERATION(ORA, 0x12)
		OPERATION(ORA, 0x13)
		OPERATION(ORA, 0x15)
		OPERATION(ORA, 0x17)
		OPERATION(ORA, 0x19)
		OPERATION(ORA, 0x1D)
		OPERATION(ORA, 0x1F)
		OPERATION(PEA, 0xF4)
		OPERATION(PEI, 0xD4)
		OPERATION(PER, 0x62)
		OPERATION(PHA, 0x48)
		OPERATION(PHB, 0x8B)
		OPERATION(PHD, 0x0B)
		OPERATION(PHK, 0x4B)
		// #TODO: PHP?
		OPERATION(PHX, 0xDA)
		OPERATION(PHY, 0x5A)
		OPERATION(PLA, 0x68)
		OPERATION(PLB, 0xAB)
		OPERATION(PLD, 0x2B)
		OPERATION(PLP, 0x28)
		OPERATION(PLX, 0xFA)
		OPERATION(PLY, 0x7A)
		OPERATION(REP, 0xC2)
		OPERATION(ROL, 0x26)
		OPERATION(ROL, 0x2A)
		OPERATION(ROL, 0x2E)
		OPERATION(ROL, 0x36)
		OPERATION(ROL, 0x3E)
		OPERATION(ROR, 0x66)
		OPERATION(ROR, 0x6A)
		OPERATION(ROR, 0x6E)
		OPERATION(ROR, 0x76)
		OPERATION(ROR, 0x7E)
		OPERATION(RTI, 0x40)
		OPERATION(RTS, 0x60)
		OPERATION(RTL, 0x6B)
		OPERATION(SBC, 0xE1)
		OPERATION(SBC, 0xE3)
		OPERATION(SBC, 0xE5)
		OPERATION(SBC, 0xE7)
		OPERATION(SBC, 0xE9)
		OPERATION(SBC, 0xED)
		OPERATION(SBC, 0xEF)
		OPERATION(SBC, 0xF1)
		OPERATION(SBC, 0xF2)
		OPERATION(SBC, 0xF3)
		OPERATION(SBC, 0xF5)
		OPERATION(SBC, 0xF7)
		OPERATION(SBC, 0xF9)
		OPERATION(SBC, 0xFD)
		OPERATION(SBC, 0xFF)
		OPERATION(SEC, 0x38)
		OPERATION(SED, 0xF8)
		OPERATION(SEI, 0x78)
		OPERATION(SEP, 0xE2)
		OPERATION(STA, 0x81)
		OPERATION(STA, 0x83)
		OPERATION(STA, 0x85)
		OPERATION(STA, 0x87)
		OPERATION(STA, 0x8D)
		OPERATION(STA, 0x8F)
		OPERATION(STA, 0x91)
		OPERATION(STA, 0x92)
		OPERATION(STA, 0x93)
		OPERATION(STA, 0x95)
		OPERATION(STA, 0x97)
		OPERATION(STA, 0x99)
		OPERATION(STA, 0x9D)
		OPERATION(STA, 0x9F)
		OPERATION(STX, 0x86)
		OPERATION(STX, 0x8E)
		OPERATION(STX, 0x96)
		OPERATION(STY, 0x84)
		OPERATION(STY, 0x8C)
		OPERATION(STY, 0x94)
		OPERATION(STP, 0xDB)
		OPERATION(STZ, 0x64)
		OPERATION(STZ, 0x74)
		OPERATION(STZ, 0x9C)
		OPERATION(STZ, 0x9E)
		OPERATION(TAX, 0xAA)
		OPERATION(TAY, 0xA8)
		OPERATION(TCD, 0x5B)
		OPERATION(TCS, 0x1B)
		OPERATION(TDC, 0x7B)
		OPERATION(TSC, 0x3B)
		OPERATION(TSX, 0xBA)
		OPERATION(TXA, 0x8A)
		OPERATION(TXS, 0x9A)
		OPERATION(TXY, 0x9B)
		OPERATION(TYA, 0x98)
		OPERATION(TYX, 0xBB)
		OPERATION(TRB, 0x14)
		OPERATION(TRB, 0x1C)
		OPERATION(TSB, 0x04)
		OPERATION(TSB, 0x0C)
		OPERATION(WAI, 0xCB)
		// #TODO: XBA?
		OPERATION(XCE, 0xFB)

		default:
			std::cout << "ERROR: Unknown instruction!\n";
	}

#undef OPERATION

	std::cout << "Disassembled: " << Result.OpCode << "\n";

	return Result;
}

void WDC65816::Execute(const Instruction& InInstruction)
{
	ExecutionMap[InInstruction.OpCode](*this, InInstruction.Hex);  // #TODO: Static search
}